<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ChatGPT</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'default.min.css' %}">
    <script src="{% static 'highlight.min.js' %}"></script>
    <script src="{% static 'html2canvas.js' %}"></script>

    <style>
        #right{
            float: right;
        }
        #save-image-btn{
            float: right;
        }
    </style>
</head>
<body >
<div class="container my-5" >
    <h3>ChatGPT WebğŸ¤—</h3>
    <hr>
    <div class="my-4"></div>
    <form id="chat-form">
        <div class="form-group">
            <label for="message">è¯·è¾“å…¥æ¶ˆæ¯ï¼š</label>
            <input type="text" id="message" name="message" class="form-control" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„æ¶ˆæ¯...">
        </div>
        <button type="submit" class="btn btn-primary">å‘é€</button>
        <div class="form-group form-check" id="right">
            <input type="checkbox" id="context-switch" name="context-switch" class="form-check-input" style="margin-right: 20px">
            <label class="form-check-label" for="context-switch" style="margin-right: 20px">è®°å½•èŠå¤©è®°å½•</label>
            <input type="checkbox" id="context-switch1" name="context-switch" class="form-check-input">
            <label class="form-check-label" for="context-switch">è”ç½‘</label>
        </div>
        <br>
        <div class="mb-3" >
            <div class="row align-items-center">
                <div class="col-auto">
                    <h6 class="cent mb-0">Chat-box:</h6>
                </div>
                <div class="col-auto">
                    <button type=button id="save-image-btn" class="btn btn-danger mt-3" style="margin-bottom: 10px">ä¿å­˜ä¸ºå›¾ç‰‡</button>
                </div>
            </div>

            <div class="container border overflow-auto h-50" style="position:absolute; height:400px; overflow:auto;background-color: white" id="chat-box"></div>
        </div>
</div>

<script>
    $(function () {
        $('#chat-form').submit(function (event) {
            event.preventDefault();
            var message = $('#message').val();
            var useContext = $('#context-switch').is(':checked');
            var internet = $('#context-switch1').is(':checked');
            if (!message) {
                alert('æ¶ˆæ¯ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            $.post('/chat', {message: message, useContext: useContext, internet: internet}, function (data) {
                if (data.error) {
                    alert(data.error);
                } else {
                    var dateTime = new Date();
                    var time = dateTime.toLocaleTimeString();
                    var mark =marked.parse(data.response).replace(/<\/?p>/g,'');
                    $('#chat-box').append('<div><h5>('+ time + ')ğŸ˜‰ï¼š ' + message + '</h5></div>');
                    $('#chat-box').append('<div><h5>('+ time + ')ğŸ¤–ï¼š ' + mark + '</h5></div>');
                    $('#message').val('');
                    $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    hljs.initHighlightingOnLoad();
                }
            });
        });
    });
    // è·å–ä¿å­˜ä¸ºå›¾ç‰‡çš„æŒ‰é’®å…ƒç´ 
    const saveImageButton = document.getElementById('save-image-btn');

    // æ·»åŠ æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    saveImageButton.addEventListener('click', () => {
        // è·å–è¦è½¬æ¢ä¸ºå›¾ç‰‡çš„ HTML å…ƒç´ 
        const element = document.getElementById('chat-box');

        // å°† HTML å…ƒç´ æ¸²æŸ“åˆ° canvas ä¸Š
        html2canvas(element).then(canvas => {
            // å°† canvas è½¬æ¢ä¸º base64 ç¼–ç çš„æ•°æ® URI
            const dataUrl = canvas.toDataURL();

            // åˆ›å»ºä¸€ä¸ªæ–°çš„ a æ ‡ç­¾å…ƒç´ ï¼Œå¹¶è®¾ç½®å…¶ href å±æ€§ä¸ºæ•°æ® URI
            const link = document.createElement('a');
            link.href = dataUrl;

            // è®¾ç½® a æ ‡ç­¾çš„ download å±æ€§ï¼ŒæŒ‡å®šæ–‡ä»¶åä¸º image.pngï¼Œå¯è‡ªè¡Œæ›´æ”¹
            link.download = 'image.jpg';

            // å°† a æ ‡ç­¾æ·»åŠ åˆ°æ–‡æ¡£ä¸­ï¼Œå¹¶æ¨¡æ‹Ÿç‚¹å‡»ä¸‹è½½é“¾æ¥
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });

</script>

</body>
</html>
